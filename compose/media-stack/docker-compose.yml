services:
  sonarr:
    env_file:
      - ../_shared/.env
      - ./.env
    image: lscr.io/linuxserver/sonarr:latest
    container_name: sonarr
    environment:
      - UMASK=002
    volumes:
      - ${CONFIG_ROOT}/sonarr:/config
      - ${MEDIA_ROOT}:/media
      - ${CACHE_ROOT}/downloads:/downloads
    ports:
      - "${SONARR_PORT}:8989"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "bash", "-lc", "curl -fsS http://localhost:8989/ping || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 10
    networks:
      homelab:
        ipv4_address: 172.18.0.10
      default:
  radarr:
    image: lscr.io/linuxserver/radarr:latest
    container_name: radarr
    env_file:
      - ../_shared/.env
      - ./.env
    environment:
      - UMASK=002
    volumes:
      - ${CONFIG_ROOT}/radarr:/config
      - ${MEDIA_ROOT}:/media
      - ${CACHE_ROOT}/downloads:/downloads
    ports:
      - "${RADARR_PORT}:7878"
    networks:
      homelab:
        ipv4_address: 172.18.0.11
      default:
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "bash", "-lc", "curl -fsS http://localhost:7878/ping || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 10

  lidarr:
    image: lscr.io/linuxserver/lidarr:latest
    container_name: lidarr
    restart: unless-stopped
    ports:
      - "8686:8686"
    env_file:
      - ../_shared/.env
      - ./.env
    environment:
      - UMASK=002
    volumes:
      - /srv/config/lidarr:/config
      - /srv/media/music:/music  
      - /srv/cache/downloads:/downloads 
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:8686/ping"]
      interval: 30s
      timeout: 5s
      retries: 10
    networks:
      homelab:
         ipv4_address: 172.18.0.12
      default:
  bazarr:
    image: lscr.io/linuxserver/bazarr:latest
    container_name: bazarr
    env_file:
      - ../_shared/.env
      - ./.env
    environment:
      - UMASK=002
    volumes:
      - ${CONFIG_ROOT}/bazarr:/config
      - ${MEDIA_ROOT}:/media
    ports:
      - "${BAZARR_PORT}:6767"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "bash", "-lc", "curl -fsS http://localhost:6767/ >/dev/null || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 10
      start_period: 30s
  jellyfin:
    image: jellyfin/jellyfin:latest   # start with :latest; weâ€™ll pin to a digest after first pull
    container_name: jellyfin
    env_file:
      - ../_shared/.env
      - ./.env
    user: "${PUID}:${PGID}"
    group_add:
      - "44" #viedo
      - "993" #render
    ports:
      - "8096:8096"     # HTTP
      # - "8920:8920"   # HTTPS (enable later if you need)
    volumes:
      - ${CONFIG_ROOT}/jellyfin:/config
      - ${MEDIA_ROOT}:/media:ro              # read-only; Sonarr/Radarr manage writes
      - ${CACHE_ROOT}/transcodes:/transcode  # fast SSD for transcoding
    devices:
      - /dev/dri:/dev/dri   # Intel iGPU (VAAPI) on your X1 Yoga
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:8096/health" ]
      interval: 30s
      timeout: 5s
      retries: 10
      start_period: 30s
  plex:
    image: lscr.io/linuxserver/plex:latest
    container_name: plex
    env_file:
      - ../_shared/.env
      - ./.env
    environment:
      #- PLEX_CLAIM=
      - UMASK=002
      - ADVERTISE_IP=http://10.10.2.1:32400/,http://srv-media.home.arpa:32400/
      #-ADVERTISE_IP=http://10.10.2.1:32400/
    ports:
      - "32400:32400"
    volumes:
      - ${CONFIG_ROOT}/plex:/config
      - ${MEDIA_ROOT}:/media:ro
      - ${CACHE_ROOT}/transcodes:/transcode
    devices:
      - /dev/dri:/dev/dri
    user: "${PUID}:${PGID}"
    group_add:
      - "44"  # video
      - "993" # render
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "bash", "-lc", "curl -fsS http://localhost:32400/identity || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 10
      start_period: 60s
  jellyseerr:
    image: fallenbagel/jellyseerr:latest
    container_name: jellyseerr
    env_file:
      - ../_shared/.env
      - ./.env
    environment:
      - LOG_LEVEL=info
      - PORT=5055
    user: "${PUID}:${PGID}"
    volumes:
      - ${CONFIG_ROOT}/jellyseerr:/app/config
    ports:
      - "${OVERSEERR_PORT:-5055}:5055"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:5055',r=>process.exit(r.statusCode===200?0:1)).on('error',()=>process.exit(1))"]
      interval: 30s
      timeout: 5s
      retries: 10
      start_period: 60s
  homepage:
    image: ghcr.io/gethomepage/homepage:latest
    container_name: homepage
    env_file:
      - ../_shared/.env
      - ./.env
    ports:
      - "3000:3000"
    networks:
      - homelab
      - default
    environment:
      #- HOMEPAGE_ALLOWED_HOSTS=192.168.4.90:3000,srv-media:3000,srv-media.home.arpa:3000
      - HOMEPAGE_ALLOWED_HOSTS=http://srv-media.home.arpa:3001,10.10.2.2:3000,srv-media:3000
    user: "${PUID}:${PGID}"   # ensure read access everywhere
    volumes:
      - /srv/config/homepage:/app/config
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - type: bind
        source: /srv
        target: /srv
        read_only: true
        bind:
          propagation: rshared
    sysctls:
      net.ipv6.conf.all.disable_ipv6: "1"
      net.ipv6.conf.default.disable_ipv6: "1"
      net.ipv6.conf.lo.disable_ipv6: "1"
    restart: unless-stopped
## this container is to be accessed only via Tailscale
  homepage-ts:
    image: ghcr.io/gethomepage/homepage:latest
    container_name: homepage-ts
    env_file:
      - ../_shared/.env
      - ./.env
    ports:
      - "3001:3000"
    networks:
      - homelab
      - default
    environment:
      - HOMEPAGE_ALLOWED_HOSTS=100.82.212.3:3001,srv-media:3001,srv-media.home.arpa:3001
    user: "${PUID}:${PGID}"   # ensure read access everywhere
    volumes:
      - /srv/config/homepage-ts:/app/config
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - type: bind
        source: /srv
        target: /srv
        read_only: true
        bind:
          propagation: rshared
    sysctls:
      net.ipv6.conf.all.disable_ipv6: "1"
      net.ipv6.conf.default.disable_ipv6: "1"
      net.ipv6.conf.lo.disable_ipv6: "1"
    restart: unless-stopped
networks:
  homelab:
    external: true
